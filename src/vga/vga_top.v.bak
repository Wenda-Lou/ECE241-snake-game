// ===========================================================
// Module: vga_top
// Description:
//   Top level: snake head, grid mapper, random fruit placer, painter, and VGA adapter (all in the same 50 MHz clock domain).
// ===========================================================
module vga_top(
    input  wire CLOCK_50,
    input  wire [1:0] KEY,  // KEY[0] = resetn
	 input  wire [1:0] dir,
    output wire [7:0] VGA_R,
    output wire [7:0] VGA_G,
    output wire [7:0] VGA_B,
    output wire       VGA_HS,
    output wire       VGA_VS,
    output wire       VGA_BLANK_N,
    output wire       VGA_SYNC_N,
    output wire       VGA_CLK
);
    // Basic parameters
    localparam H_RES     = 640;
    localparam V_RES     = 480;
    localparam CELL_PX   = 16;
    localparam GRID_W    = H_RES / CELL_PX;  // 40
    localparam GRID_H    = V_RES / CELL_PX;  // 30
    localparam X0_OFFSET = 0;
    localparam Y0_OFFSET = 0;

    wire resetn = KEY[0];

    // (Simulation/check reminder) If the grid ever grows to >=64 cells, also widen the fruit_placer port widths.
    // initial begin
    //   if (GRID_W > 64 || GRID_H > 64) $error("Grid exceeds 6-bit range; widen fruit_placer ports.");
    // end

    // Snake-head cell coordinates (if snake_head outputs [9:0], it is still safe to truncate to [5:0]).
    // Explanation: with GRID_W=40 and GRID_H=30, all values are <64 so no significant bits are lost.
    // wire [9:0] x_cell, y_cell;

	 
	 //----------------------------------------------
	 // 1 Hz movement tick for the snake
	 //----------------------------------------------
	 wire snake_step;

	 game_tick #(
		 .INPUT_CLK_FREQ(50_000_000),
		 .TICK_FREQ     (1)
	 ) u_move_tick (
		 .clk    (CLOCK_50),
		 .resetn (resetn),
		 .tick   (snake_step)
	 );

	 // snake engine (CELL coordinates)
	 wire [5:0] snake_x_cell6, snake_y_cell6;
	 wire [7:0] snake_len;
	 wire       ate_fruit;
	 wire       game_over;

	 // direction input from PS/2 logic goes here:
	 // wire [1:0] dir;  // connect from PS/2 decoder in top-level

	 snake_engine #(
		 .H_CELLS(40),
		 .V_CELLS(30),
		 .MAX_LEN(64)
	 ) u_snake (
		 .clk               (CLOCK_50),
		 .rst_n             (resetn),
		 .step              (snake_step),
		 .dir               (dir),
		 .fruit_x_cell      (fruit_x_cell),
		 .fruit_y_cell      (fruit_y_cell),
		 .snake_head_x_cell (snake_x_cell6),
		 .snake_head_y_cell (snake_y_cell6),
		 .game_over         (game_over),
		 .ate_fruit         (ate_fruit),
		 .snake_len         (snake_len)
	 );

	 // x_cell/y_cell for grid_mapper
	 wire [9:0] x_cell = {4'b0000, snake_x_cell6};
	 wire [9:0] y_cell = {4'b0000, snake_y_cell6};

    // Random fruit coordinates (cell space)
    wire [5:0] fruit_x_cell, fruit_y_cell;
    wire       fruit_done, fruit_busy;

    // After reset, request one generation (hold high until done)
    reg fruit_req;
    always @(posedge CLOCK_50 or negedge resetn) begin
        if (!resetn)      fruit_req <= 1'b1;
        else if (fruit_done) fruit_req <= 1'b0;
    end

    fruit_placer #(
        .CELL_PX(16), .H_CELLS(40), .V_CELLS(30),
        .MARGIN_CELLS(1), .TRIES(16), .MIN_DIST(3)
    ) u_fruit (
        .clk          (CLOCK_50),
        .resetn       (resetn),
        .request      (ate_fruit || fruit_req),
        .snake_x_cell (snake_x_cell6),
        .snake_y_cell (snake_y_cell6),
        .fruit_x_cell (fruit_x_cell),
        .fruit_y_cell (fruit_y_cell),
        .done         (fruit_done),
        .busy         (fruit_busy)
    );

    // cell -> pixel center (*16 + 8)
    wire [9:0] fruit_cx = {fruit_x_cell, 4'b0000} + 10'd8;
    wire [9:0] fruit_cy = {fruit_y_cell, 4'b0000} + 10'd8;

    // Grid mapper: snake-head cell -> pixel range
    wire [9:0] x_min_px, x_max_px;
    wire [9:0] y_min_px, y_max_px;
    grid_mapper u_mapper (
        .x_cell   (x_cell),
        .y_cell   (y_cell),
        .x_min_px (x_min_px),
        .x_max_px (x_max_px),
        .y_min_px (y_min_px),
        .y_max_px (y_max_px)
    );

    // Painter module
    wire [9:0] x;
    wire [9:0] y;
    wire [2:0] color_3b;
    wire       write_stb;
    wire       busy;

    // 3-bit -> 9-bit (RRR GGG BBB)
    wire [8:0] color_9b = { {3{color_3b[2]}}, {3{color_3b[1]}}, {3{color_3b[0]}} };

    painter u_painter (
        .clk       (CLOCK_50),
        .resetn    (resetn),
        .x_min_px  (x_min_px),
        .x_max_px  (x_max_px),
        .y_min_px  (y_min_px),
        .y_max_px  (y_max_px),
        .fruit_cx  (fruit_cx),
        .fruit_cy  (fruit_cy),
        .x         (x),
        .y         (y),
        .colour    (color_3b),
        .plot      (write_stb),
        .busy      (busy)
    );

    // VGA adapter (rename the ports if your IP uses .colour/.plot)
    vga_adapter VGA (
        .resetn      (resetn),
        .clock       (CLOCK_50),
        .color       (color_9b),
        .x           (x),
        .y           (y),
        .write       (write_stb),
        .VGA_R       (VGA_R),
        .VGA_G       (VGA_G),
        .VGA_B       (VGA_B),
        .VGA_HS      (VGA_HS),
        .VGA_VS      (VGA_VS),
        .VGA_BLANK_N (VGA_BLANK_N),
        .VGA_SYNC_N  (VGA_SYNC_N),
        .VGA_CLK     (VGA_CLK)
    );
    defparam VGA.RESOLUTION        = "640x480";
    defparam VGA.COLOR_DEPTH       = 9;
    defparam VGA.BACKGROUND_IMAGE  = "";
endmodule